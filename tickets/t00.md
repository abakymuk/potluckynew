T0.0 — Monorepo bootstrap (pnpm + turbo)

Role: Codebase Guardian for Next.js 15 (edge) monorepo on Vercel.
Non-negotiables: contracts-first, mocks-first, feature flags, disciplined migrations, tests & telemetry.

Goal

Поднять рабочий монорепо c pnpm+turbo, базовыми пакетами (ui, config, contracts, types), едиными линт/тайпчек правилами и сборкой. Никаких бизнес-фич.

Scope

In: pnpm workspaces, turbo pipeline, packages/_ с tsup сборкой, общие ts/eslint/prettier, базовый README.
Out: приложения apps/_, БД, CI/CD, auth, UI-экраны.

AC (Gherkin)
• Given пустой репозиторий, When я выполняю pnpm i && pnpm -w build, Then все пакеты в packages/\* успешно собираются (esm+cjs) и публикуют типы.
• Given я запускаю pnpm -w lint и pnpm -w typecheck, Then проверка проходит без ошибок.
• Given в любом пакете отсутствует обязательная мета (name, main, types), Then сборка падает с понятной ошибкой (скрипт валидатора).

UX

Figma#: N/A (инфраструктурный тикет)

Contracts

OpenAPI#/ERD#: N/A (создаём каркас packages/contracts с пустыми схемами и пайплайном сборки)

DoD
• pnpm-workspace.yaml, package.json (workspace), turbo.json, tsconfig.base.json на месте
• packages/{ui,config,contracts,types} собираются tsup’ом (cjs+esm+d.ts)
• Общие .eslintrc.cjs, .prettierrc, .editorconfig, .gitignore
• Команды pnpm -w build/lint/typecheck/test проходят
• README с деревом каталогов и правилами коммитов
• Скрипт pnpm validate:packages валидирует манифесты

Steps (выполнить ровно по порядку)

1. Инициализация workspace

git init
pnpm init -y
pnpm add -D turbo tsup typescript tsx eslint prettier vitest @types/node

pnpm-workspace.yaml

packages:

- "apps/\*"
- "packages/\*"
- "infra/\*"

root package.json (минимум)

{
"name": "potlucky-monorepo",
"private": true,
"packageManager": "pnpm@9",
"scripts": {
"build": "turbo run build",
"dev": "turbo run dev",
"lint": "turbo run lint",
"typecheck": "turbo run typecheck",
"test": "turbo run test",
"validate:packages": "node ./infra/scripts/validate-packages.mjs",
"format": "prettier --write ."
},
"devDependencies": {
"turbo": "^2.0.0",
"tsup": "^8.0.0",
"typescript": "^5.6.0",
"tsx": "^4.16.0",
"eslint": "^9.8.0",
"prettier": "^3.3.3",
"vitest": "^2.0.0",
"@types/node": "^20.14.10"
}
}

turbo.json

{
"$schema": "https://turbo.build/schema.json",
"pipeline": {
"build": {
"outputs": ["dist/**"],
"dependsOn": ["^build"]
},
"dev": {
"cache": false
},
"lint": {},
"typecheck": {},
"test": {
"outputs": [".vitest/**", "coverage/**"]
}
}
}

tsconfig.base.json

{
"compilerOptions": {
"target": "ES2022",
"module": "ESNext",
"moduleResolution": "Bundler",
"lib": ["ES2022", "DOM"],
"jsx": "react-jsx",
"strict": true,
"noUncheckedIndexedAccess": true,
"skipLibCheck": true,
"resolveJsonModule": true,
"types": ["node"],
"baseUrl": ".",
"paths": {
"@ui/_": ["packages/ui/src/_"],
"@config/_": ["packages/config/src/_"],
"@contracts/_": ["packages/contracts/src/_"],
"@types/_": ["packages/types/src/_"]
}
}
}

.eslintrc.cjs

module.exports = {
root: true,
parser: "@typescript-eslint/parser",
plugins: ["@typescript-eslint"],
extends: ["eslint:recommended", "plugin:@typescript-eslint/recommended"],
ignorePatterns: ["dist", ".turbo", "node_modules"],
};

.prettierrc

{
"singleQuote": true,
"semi": false,
"trailingComma": "all",
"printWidth": 100
}

.editorconfig

root = true
[*]
charset = utf-8
end_of_line = lf
indent_style = space
indent_size = 2
insert_final_newline = true

.gitignore

node_modules
dist
.turbo
.vscode
.env\*
coverage

2. Пакеты (каркасы)

Создай каталоги:

packages/
ui/
config/
contracts/
types/
infra/
scripts/

Шаблон для каждого packages/<name>/package.json:

{
"name": "@potlucky/<name>",
"version": "0.0.0",
"private": false,
"type": "module",
"main": "dist/index.cjs",
"module": "dist/index.mjs",
"types": "dist/index.d.ts",
"exports": {
".": {
"require": "./dist/index.cjs",
"import": "./dist/index.mjs",
"types": "./dist/index.d.ts"
}
},
"scripts": {
"build": "tsup src/index.ts --dts --format cjs,esm --clean",
"dev": "tsup src/index.ts --dts --format cjs,esm --watch",
"lint": "eslint . --ext .ts,.tsx",
"typecheck": "tsc -p tsconfig.json --noEmit",
"test": "vitest run"
},
"devDependencies": {
"tsup": "^8.0.0",
"typescript": "^5.6.0",
"vitest": "^2.0.0"
}
}

Создай tsconfig.json в каждом пакете:

{
"extends": "../../tsconfig.base.json",
"include": ["src"]
}

Минимальный код:

packages/ui/src/index.ts

export const uiReady = () => true

packages/config/src/index.ts

export type FeatureFlags = {
ONLINE_ORDERING_V1: boolean
ORDER_QUEUE_V1: boolean
AI_ADVISOR_V1: boolean
}
export const flags: FeatureFlags = {
ONLINE_ORDERING_V1: false,
ORDER_QUEUE_V1: false,
AI_ADVISOR_V1: false
}

packages/contracts/src/index.ts

// placeholder для будущих zod-схем и openapi-генерации
export const contractsReady = () => true

packages/types/src/index.ts

export type BrandId = string & { readonly \_\_brand: unique symbol }

3. Валидация манифестов

infra/scripts/validate-packages.mjs

import { readFile } from 'node:fs/promises'
import { join } from 'node:path'
import { readdirSync, statSync } from 'node:fs'

const pkgsDir = join(process.cwd(), 'packages')
const pkgs = readdirSync(pkgsDir).filter(d => statSync(join(pkgsDir, d)).isDirectory())

let ok = true
for (const p of pkgs) {
const pkgPath = join(pkgsDir, p, 'package.json')
const pkg = JSON.parse(await readFile(pkgPath, 'utf8'))
const required = ['name', 'main', 'module', 'types', 'exports', 'scripts']
const missing = required.filter(k => !(k in pkg))
if (missing.length) {
console.error(`Package ${pkg.name || p} missing fields: ${missing.join(', ')}`)
ok = false
}
}

process.exit(ok ? 0 : 1)

4. Root scripts и удобные алиасы

Добавь в root package.json:

{
"scripts": {
"build": "turbo run build",
"dev": "turbo run dev --parallel",
"lint": "turbo run lint",
"typecheck": "turbo run typecheck",
"test": "turbo run test",
"validate:packages": "node ./infra/scripts/validate-packages.mjs",
"ci": "pnpm -w lint && pnpm -w typecheck && pnpm -w test && pnpm -w build && pnpm validate:packages"
}
}

5. README (минимум)

README.md (в корне):

# Potlucky Monorepo (Edge/Serverless-first)

## Structure

- apps/ (пусто на этапе T0.0)
- packages/
  - ui/ – базовые UI-хелперы
  - config/ – фичефлаги и env-хелперы
  - contracts/ – схемы и контракты API (позже: zod + openapi)
  - types/ – общие типы
- infra/ – скрипты и (позже) CI/infra

## Commands

- `pnpm -w build|dev|lint|typecheck|test`
- `pnpm validate:packages`

## Rules

- Contracts-first, mocks-first, feature flags.
- Один пакет = один артефакт (cjs+esm+d.ts).

6. Проверка Acceptance Criteria

pnpm i
pnpm -w build
pnpm -w lint
pnpm -w typecheck
pnpm validate:packages
pnpm -w test

Все команды должны пройти без ошибок.

File Tree (итог T0.0)

.
├─ package.json
├─ pnpm-workspace.yaml
├─ turbo.json
├─ tsconfig.base.json
├─ .eslintrc.cjs
├─ .prettierrc
├─ .editorconfig
├─ .gitignore
├─ README.md
├─ infra/
│ └─ scripts/
│ └─ validate-packages.mjs
└─ packages/
├─ ui/
│ ├─ package.json
│ ├─ tsconfig.json
│ └─ src/index.ts
├─ config/
│ ├─ package.json
│ ├─ tsconfig.json
│ └─ src/index.ts
├─ contracts/
│ ├─ package.json
│ ├─ tsconfig.json
│ └─ src/index.ts
└─ types/
├─ package.json
├─ tsconfig.json
└─ src/index.ts

Commit message (рекомендация)

chore(repo): bootstrap pnpm+turbo monorepo with base packages and tooling
