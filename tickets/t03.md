T0.3 — Supabase + Drizzle (Edge ORM), базовая схема и миграции

Role: Codebase Guardian (Edge/Serverless).
Non-negotiables: никаких прямых process.env вне @potlucky/config; на Edge — только anon-клиент с RLS (service-role используется только в миграциях/сидере в CI/локально).

Goal

Подключить Supabase к apps/web через drizzle-orm/supabase, описать базовую схему (organizations, profiles, memberships), настроить drizzle-kit для миграций (локально и в CI), сделать health-роут БД и минимальный сид.

Scope

In: Drizzle (schema, config), миграции, seed, Edge-клиент для runtime, health-роут /api/db/health.
Out: RLS-политики (это T0.4), бизнес-таблицы (orders и т. п.).

postgresql://postgres:Gariba1ddi@db.wnqzzplxfoutblsksvud.supabase.co:5432/postgres

AC (Gherkin)
• Given заданы NEXT_PUBLIC_SUPABASE_URL и NEXT_PUBLIC_SUPABASE_ANON_KEY, When вызываю GET /api/db/health, Then получаю 200 и JSON { ok: true, tables: ["organizations","profiles","memberships"] }.
• Given установлен SUPABASE_DB_URL (Postgres connection string), When выполняю pnpm drizzle:generate && pnpm drizzle:push, Then миграции применяются без ошибок, таблицы созданы.
• Given выполняю pnpm db:seed, Then в БД появляется организация Acme и один профиль/мембершип (идемпотентно).

DoD
• infra/db/schema.ts с тремя таблицами и связями
• infra/db/drizzle.config.ts + скрипты drizzle:generate, drizzle:push
• apps/web/lib/db.ts (Edge-friendly Supabase + Drizzle клиент)
• health-роут /api/db/health на Edge
• seed-скрипт infra/db/seed.ts (через pg)
• Документация в README: необходимые ENV и команды

⸻

Steps

0. Пакеты

pnpm -w add @supabase/supabase-js drizzle-orm drizzle-kit zod
pnpm -w add -D pg dotenv

1. Drizzle config и схема

infra/db/drizzle.config.ts

import 'dotenv/config'
import type { Config } from 'drizzle-kit'

if (!process.env.SUPABASE_DB_URL) {
throw new Error('SUPABASE_DB_URL is required for migrations')
}

export default {
schema: './infra/db/schema.ts',
out: './infra/db/migrations',
driver: 'pg',
dbCredentials: {
connectionString: process.env.SUPABASE_DB_URL!,
},
strict: true,
verbose: true,
} satisfies Config

infra/db/schema.ts

import {
pgTable, uuid, text, timestamp, uniqueIndex,
} from 'drizzle-orm/pg-core'
import { relations } from 'drizzle-orm'

export const organizations = pgTable('organizations', {
id: uuid('id').defaultRandom().primaryKey(),
name: text('name').notNull(),
createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
})

export const profiles = pgTable('profiles', {
id: uuid('id').defaultRandom().primaryKey(),
// auth_user_id — из Supabase Auth JWT (sub)
authUserId: uuid('auth_user_id').notNull().unique(),
fullName: text('full_name'),
createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
}, (t) => ({
authUserIdIdx: uniqueIndex('profiles_auth_user_id_idx').on(t.authUserId),
}))

export const memberships = pgTable('memberships', {
id: uuid('id').defaultRandom().primaryKey(),
orgId: uuid('org_id').references(() => organizations.id, { onDelete: 'cascade' }).notNull(),
profileId: uuid('profile_id').references(() => profiles.id, { onDelete: 'cascade' }).notNull(),
role: text('role').notNull().$type<'owner'|'admin'|'member'>().default('owner'),
createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
}, (t) => ({
uniq: uniqueIndex('memb_org_profile_uniq').on(t.orgId, t.profileId),
}))

export const orgRelations = relations(organizations, ({ many }) => ({
memberships: many(memberships),
}))
export const profileRelations = relations(profiles, ({ many }) => ({
memberships: many(memberships),
}))
export const membershipRelations = relations(memberships, ({ one }) => ({
org: one(organizations, {
fields: [memberships.orgId],
references: [organizations.id],
}),
profile: one(profiles, {
fields: [memberships.profileId],
references: [profiles.id],
}),
}))

2. Скрипты в root package.json

Добавь:

{
"scripts": {
"drizzle:generate": "drizzle-kit generate --config ./infra/db/drizzle.config.ts",
"drizzle:push": "drizzle-kit push --config ./infra/db/drizzle.config.ts",
"db:seed": "tsx ./infra/db/seed.ts"
}
}

3. Seed (через pg)

infra/db/seed.ts

import 'dotenv/config'
import { Client } from 'pg'

const url = process.env.SUPABASE_DB_URL
if (!url) throw new Error('SUPABASE_DB_URL is required')

const client = new Client({ connectionString: url })

async function main() {
await client.connect()

// идемпотентные вставки
const org = await client.query(
`insert into organizations (name) values ($1)
     on conflict do nothing returning id`, ['Acme']
)
const orgId = org.rows[0]?.id ?? (await client.query(
`select id from organizations where name=$1 limit 1`, ['Acme']
)).rows[0].id

// Тестовый профиль (не путать с реальным Supabase auth)
const resProfile = await client.query(
`insert into profiles (auth_user_id, full_name)
     values ($1, $2) on conflict (auth_user_id) do nothing returning id`,
['00000000-0000-0000-0000-000000000001', 'Test User']
)
const profileId = resProfile.rows[0]?.id ?? (await client.query(
`select id from profiles where auth_user_id=$1 limit 1`,
['00000000-0000-0000-0000-000000000001']
)).rows[0].id

await client.query(
`insert into memberships (org_id, profile_id, role)
     values ($1, $2, $3)
     on conflict (org_id, profile_id) do nothing`,
[orgId, profileId, 'owner']
)

console.log('Seed complete:', { orgId, profileId })
await client.end()
}
main().catch(async (e) => {
console.error(e)
await client.end().catch(() => {})
process.exit(1)
})

4. Edge-клиент для Drizzle + Supabase

apps/web/lib/db.ts

import { createClient } from '@supabase/supabase-js'
import { drizzle } from 'drizzle-orm/supabase'
import { isEnabled, envPublic } from '@potlucky/config'

// Edge-совместимый Supabase client (только anon, RLS будет в T0.4)
const supabase = createClient(
envPublic.NEXT_PUBLIC_SUPABASE_URL,
envPublic.NEXT_PUBLIC_SUPABASE_ANON_KEY,
{ auth: { persistSession: false } }
)

export const db = drizzle(supabase)
// Пример: export { organizations } from '../../../infra/db/schema' — не делаем (schema — для миграций/типов)
// На runtime будем работать через RPC/табличные запросы Drizzle Supabase adapter

export const feature = { ONLINE_ORDERING_V1: isEnabled('ONLINE_ORDERING_V1') }

На Edge мы не используем service-role. Все доступы регулируются RLS (в T0.4).

5. Health-роут БД

apps/web/app/api/db/health/route.ts

export const runtime = 'edge'

import { createClient } from '@supabase/supabase-js'
import { envPublic } from '@potlucky/config'

export async function GET() {
const supabase = createClient(
envPublic.NEXT_PUBLIC_SUPABASE_URL,
envPublic.NEXT_PUBLIC_SUPABASE_ANON_KEY,
{ auth: { persistSession: false } }
)

// Проверяем доступность таблиц через lightweight запросы
const tables = ['organizations', 'profiles', 'memberships']
const checks: string[] = []
for (const t of tables) {
const { error } = await supabase.from(t).select('id').limit(1)
if (!error) checks.push(t)
}

const ok = checks.length === tables.length
return new Response(
JSON.stringify({ ok, tables: checks }),
{ status: ok ? 200 : 500, headers: { 'content-type': 'application/json' } }
)
}

6. ENV

В корневом .env (локально) и в CI Secret’ах:

# для рантайма (Edge)

NEXT_PUBLIC_SUPABASE_URL=...
NEXT_PUBLIC_SUPABASE_ANON_KEY=...

# для миграций/сидов (Node/CI)

SUPABASE_DB_URL=postgresql://postgres:password@host:5432/postgres?sslmode=require

SUPABASE_DB_URL — возьми в настройках проекта Supabase → Connection pooling (или обычный connection string). Обязательно sslmode=require в CI.

7. CI (миграции в превью) — черновик workflow

Создай infra/ci/db-migrations.yml:

name: db-migrations
on:
pull_request:
paths: - 'infra/db/\*\*' - '.github/workflows/db-migrations.yml'

jobs:
migrate:
runs-on: ubuntu-latest
env:
SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL_PREVIEW }}
steps: - uses: actions/checkout@v4 - uses: pnpm/action-setup@v4
with: { version: 9 } - run: pnpm i --frozen-lockfile - run: pnpm drizzle:generate - run: pnpm drizzle:push

Полноценный CI сведём в T0.7; этот файл — заготовка.

⸻

Проверка AC (локально)

# 1) ENV для runtime

export NEXT_PUBLIC_SUPABASE_URL="https://<project>.supabase.co"
export NEXT_PUBLIC_SUPABASE_ANON_KEY="<anon>"

# 2) ENV для миграций

export SUPABASE_DB_URL="postgresql://postgres:password@host:5432/postgres?sslmode=require"

pnpm drizzle:generate
pnpm drizzle:push
pnpm db:seed

# 3) health-роут

pnpm --filter @potlucky/web dev
curl -s http://localhost:3000/api/db/health

# -> {"ok":true,"tables":["organizations","profiles","memberships"]}

Рекомендованный коммит

feat(db): add Supabase + Drizzle (edge) with base schema, migrations, health route and seed
